<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pkgman - 에어갭 환경을 위한 패키지 관리자</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <a href="#" class="logo-link">pkgman</a>
            </div>
            <div class="header-actions">
                <button id="theme-toggle" class="icon-btn" title="테마 전환">
                    <span class="icon-sun">&#9728;</span>
                    <span class="icon-moon">&#9790;</span>
                </button>
                <a href="https://github.com/cagojeiger/pkgman" class="icon-btn" target="_blank" title="GitHub">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                    </svg>
                </a>
            </div>
        </div>
        <p class="tagline">에어갭 환경을 위한 패키지 관리자</p>
    </header>

    <main class="main">
        <div id="main-view" class="view">
            <div id="cards-container" class="cards-container">
                <div class="loading">데이터 로딩 중...</div>
            </div>
        </div>

        <div id="detail-view" class="view hidden">
            <div class="detail-header">
                <button id="back-btn" class="back-btn">&larr; 뒤로</button>
            </div>
            <div id="detail-content"></div>
        </div>
    </main>

    <footer class="footer">
        <span id="last-updated">Last updated: -</span>
    </footer>

    <script>
        const DATA_URL = 'data/packages.json';
        let packagesData = null;

        // Theme toggle
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
            }
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        });

        // Copy to clipboard
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Render cards
        function renderCards(data) {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';

            const tools = data.tools;
            const order = ['bintools', 'rpmtools', 'snaptools'];

            order.forEach(toolName => {
                if (!tools[toolName]) return;
                const tool = tools[toolName];
                const card = createCard(tool);
                container.appendChild(card);
            });

            // Update last updated
            const date = new Date(data.generated_at);
            document.getElementById('last-updated').textContent =
                `Last updated: ${date.toISOString().slice(0, 16).replace('T', ' ')} UTC`;
        }

        function createCard(tool) {
            const card = document.createElement('div');
            card.className = 'card';

            const isRpmtools = tool.name === 'rpmtools';
            let versionDisplay, downloadUrl, packageCount;

            if (isRpmtools) {
                const osVersions = Object.keys(tool.os_versions).sort().reverse();
                const firstOs = osVersions[0];
                const firstData = tool.os_versions[firstOs];
                versionDisplay = `Rocky ${firstOs}`;
                downloadUrl = firstData.download_url;
                packageCount = firstData.packages.length;

                // Create dropdown for multiple OS versions
                if (osVersions.length > 1) {
                    versionDisplay = createOsDropdown(tool, osVersions, firstOs);
                }
            } else {
                versionDisplay = tool.version;
                downloadUrl = tool.download_url;
                packageCount = tool.packages.length;
            }

            const packageSummary = getPackageSummary(tool);
            const curlCmd = `curl -LO "${downloadUrl}" && chmod +x ${tool.name === 'bintools' ? 'bintools' : tool.name + '-bundle'}`;

            card.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">&#128230;</span>
                    <span class="card-title">${tool.name}</span>
                    <span class="card-version">${typeof versionDisplay === 'string' ? versionDisplay : ''}</span>
                </div>
                <p class="card-desc">${tool.description} - ${packageSummary} 외 ${Math.max(0, packageCount - 3)}개</p>
                <div class="card-code">
                    <code id="curl-${tool.name}">${curlCmd}</code>
                    <button class="copy-btn" onclick="copyToClipboard(document.getElementById('curl-${tool.name}').textContent, this)">&#128203;</button>
                </div>
                <div class="card-actions">
                    <a href="#${tool.name}" class="detail-link">상세 &rarr;</a>
                </div>
            `;

            // Insert dropdown if exists
            if (typeof versionDisplay !== 'string') {
                const versionSpan = card.querySelector('.card-version');
                versionSpan.innerHTML = '';
                versionSpan.appendChild(versionDisplay);
            }

            return card;
        }

        function createOsDropdown(tool, osVersions, selectedOs) {
            const select = document.createElement('select');
            select.className = 'os-select';
            osVersions.forEach(os => {
                const option = document.createElement('option');
                option.value = os;
                option.textContent = `Rocky ${os}`;
                if (os === selectedOs) option.selected = true;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                const os = e.target.value;
                const data = tool.os_versions[os];
                const card = select.closest('.card');
                const codeEl = card.querySelector('code');
                codeEl.textContent = `curl -LO "${data.download_url}" && chmod +x rpmtools-bundle`;
            });

            return select;
        }

        function getPackageSummary(tool) {
            let packages;
            if (tool.name === 'rpmtools') {
                const firstOs = Object.keys(tool.os_versions).sort().reverse()[0];
                packages = tool.os_versions[firstOs].packages;
            } else {
                packages = tool.packages;
            }
            return packages.slice(0, 3).map(p => p.name).join(', ');
        }

        // Detail view
        function renderDetail(toolName) {
            if (!packagesData || !packagesData.tools[toolName]) {
                showMainView();
                return;
            }

            const tool = packagesData.tools[toolName];
            const content = document.getElementById('detail-content');
            const isRpmtools = tool.name === 'rpmtools';

            let html = `
                <div class="detail-title">
                    <span class="detail-icon">&#128230;</span>
                    <h1>${tool.name}</h1>
                </div>
                <p class="detail-desc">${tool.description}</p>
            `;

            if (isRpmtools) {
                html += renderRpmtoolsDetail(tool);
            } else {
                html += renderSimpleDetail(tool);
            }

            content.innerHTML = html;

            // Add copy button handlers
            content.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.closest('.detail-code').querySelector('code').textContent;
                    copyToClipboard(code, e.target);
                });
            });

            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
        }

        function renderSimpleDetail(tool) {
            const installCmd = tool.name === 'bintools'
                ? `curl -LO "${tool.download_url}"\nchmod +x bintools\n./bintools install kubectl helm`
                : `curl -LO "${tool.download_url}"\nchmod +x ${tool.name}-bundle\nsudo ./${tool.name}-bundle`;

            return `
                <p class="detail-build">Build: ${tool.version}</p>
                <div class="detail-code">
                    <pre><code>${installCmd}</code></pre>
                    <button class="copy-btn">&#128203;</button>
                </div>
                <h2>&#128203; 전체 패키지 목록 (${tool.packages.length})</h2>
                ${renderPackageTable(tool.packages)}
            `;
        }

        function renderRpmtoolsDetail(tool) {
            const osVersions = Object.keys(tool.os_versions).sort().reverse();
            let html = `
                <div class="os-tabs">
                    ${osVersions.map((os, i) => `
                        <button class="os-tab ${i === 0 ? 'active' : ''}" data-os="${os}">Rocky ${os}</button>
                    `).join('')}
                </div>
            `;

            osVersions.forEach((os, i) => {
                const data = tool.os_versions[os];
                const installCmd = `curl -LO "${data.download_url}"\nchmod +x rpmtools-bundle\nsudo ./rpmtools-bundle`;

                html += `
                    <div class="os-content ${i === 0 ? '' : 'hidden'}" data-os="${os}">
                        <p class="detail-build">Build: ${data.build}</p>
                        <div class="detail-code">
                            <pre><code>${installCmd}</code></pre>
                            <button class="copy-btn">&#128203;</button>
                        </div>
                        <h2>&#128203; 전체 패키지 목록 (${data.packages.length})</h2>
                        ${renderPackageTable(data.packages)}
                    </div>
                `;
            });

            setTimeout(() => {
                document.querySelectorAll('.os-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const os = e.target.dataset.os;
                        document.querySelectorAll('.os-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.os-content').forEach(c => c.classList.add('hidden'));
                        e.target.classList.add('active');
                        document.querySelector(`.os-content[data-os="${os}"]`).classList.remove('hidden');
                    });
                });
            }, 0);

            return html;
        }

        function renderPackageTable(packages) {
            if (!packages || packages.length === 0) {
                return '<p>패키지 정보 없음</p>';
            }

            return `
                <table class="package-table">
                    <thead>
                        <tr>
                            <th>Package</th>
                            <th>Version</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${packages.map(pkg => `
                            <tr>
                                <td>${pkg.name}</td>
                                <td>${pkg.version || '-'}</td>
                                <td>${pkg.description || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMainView() {
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            history.pushState(null, '', window.location.pathname);
        }

        // Hash routing
        function handleHash() {
            const hash = window.location.hash.slice(1);
            if (hash && packagesData) {
                renderDetail(hash);
            } else {
                showMainView();
            }
        }

        document.getElementById('back-btn').addEventListener('click', showMainView);
        document.querySelector('.logo-link').addEventListener('click', (e) => {
            e.preventDefault();
            showMainView();
        });
        window.addEventListener('hashchange', handleHash);

        // Initialize
        async function init() {
            initTheme();

            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error('Failed to load data');
                packagesData = await response.json();
                renderCards(packagesData);
                handleHash();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('cards-container').innerHTML =
                    '<div class="error">데이터를 불러오는데 실패했습니다.</div>';
            }
        }

        init();
    </script>
</body>
</html>
